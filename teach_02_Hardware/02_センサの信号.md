# センサの通信

マイコンも半導体の集積で形作られたコンピューターであり、同じように半導体の集積で作られたセンサとの通信を行い外界や自身の物理状態を把握します。CanSatなど自律制御される機器であればアクチュエーターの制御も、センサの値によって決定されます。  
そのため、本記事ではマイコンにおける情報の基礎について理解することを目標としています。

## 電流と定格

中高で習った通り、電流の正体は導体内を流れる電子の移動です。勢いよく電子が流れていれば電流が大きい、あまり流れていなかったら電流が小さい、といった具合です。そして、電子を流そうとする力の強さが電圧で、原子核が電子の流れを妨げる強さが抵抗に当たります。

![電流の図](https://image.jimcdn.com/app/cms/image/transf/dimension=960x10000:format=png/path/sa07fdcab0410c43c/image/ide395796d174cdba/version/1632534935/image.png)

このオームの法則に出てくる三要素を坂を転がり落ちるビー玉(ここではこれをビー玉系とします)に例えると、以下のように相似関係を表せます。
|電気の要素|ビー玉系の要素|
|:----:|:----:|
|電子|ビー玉|
|電流|ビー玉の勢い|
|電圧|坂の角度(高低差)|
|抵抗|坂の表面粗さ|

電圧が大きいとき、坂の角度は大きく、より大きな力でビー玉を転がそうとします。よって電圧が大きくなれば電流(ビー玉の勢い)は増します。また、坂の表面が荒いとき(抵抗が大きいとき)、坂面の凹凸に邪魔されてビー玉の勢いは衰えます(電流の値が小さくなる)。  
このようにビー玉の勢いは坂の角度と表面の粗さによって決まる従属変数です。  
電子回路においても一般に、電流は電圧・抵抗値を与えることで決まる変数として扱うことが多いです。

さて、電流のイメージを持てたところで導体での話に戻ります。  
電流とはつまるところ「電子の勢い」です。  
「電子が勢いよく流れる=エネルギーが大きい」状態ですので、めちゃくちゃ**発熱**したり、**部品が爆発**する原因になります。

なので、<s>この危険を理解するために一度は部品を燃やしてみましょう</s> 素子を扱う際は電流を流しすぎないように気をつけることが大切です。

![コンデンサー爆破](https://img.youtube.com/vi/25kgoA2gpT0/sddefault.jpg)

このような電流や電圧の上限値は素子ごとに決められており、それぞれ**定格電流 ・ 定格電圧**と言われます。

電子工作においてモーター等のアクチュエータが数100mAや数Aやのオーダーであるのに対し、センサ類の定格電流が数mAや数10mAなので、電流の流しすぎには注意が必要です。

センサを使うときには必ずデータシートを見てから部品選定をし、定格内で使うようにしましょう。  
ただし、モーターなどのアクチュエータは割と丈夫なので定格を超えて使う違法建築はロボコン界隈等では常套手段だったりします←<u>**重要**</u>

## 信号の入力

電気回路において、情報のデータのやり取りは基準電圧 <u>(HIGH, 1, TRUE)</u> か<u>0V (LOW, 0, FALSE)</u> かで判断される**デジタル通信**と、0から基準電圧までの間の値で判断される**アナログ通信**がある。本資料では、デジタル通信に絞って資料を作成します。

### グラウンドの共有

電気回路において電位差は相対的なものなので、どこかに基準電圧をとらない限り安定しない電位が発生する可能性があるので、マイナス極を回路全体で共有します。  
ここで共有されるマイナス極を<u>**グラウンド**</u>といい、家電製品であれば建築材を通して地面に、自動車や航空機、人工衛星であれば構造フレーム(導体)に接続されます。  
　※衛星用電源のプロ、ぎーちさん(@BREAK_BROTHER)さんの<b><u>[ツイート](https://twitter.com/BREAK_BROTHER/status/1637183608753618944?s=20)</b></u>参照

## シリアル通信とパラレル通信

|シリアル通信|パラレル通信|
|:----:|:----:|
|![シリアル通信](https://emb.macnica.co.jp/macnica_wp/wp-content/uploads/2019/10/02234dbc439838eacee8196efba0d573.png)|![パラレル通信](https://emb.macnica.co.jp/macnica_wp/wp-content/uploads/2019/09/d843095536a66385a4ac4866c80e5950.png)|

通信には1本の通信線でデータを1bitずつ送信する<b>シリアル通信</b>と、複数の通信線でまとめて複数bitのデータを送る<b>パラレル通信</b>があります。  
一見すると一度にやり取りできるデータが多いパラレル通信が優れているように感じますが、以下の理由からシリアル通信が普及しています。

* 配線数が少なく低コスト
* 配線本数が少なく組立てが簡単
* 通信線が少なく同期が簡単

## 同期式と非同期式

シリアル通信ではデータの始まりや終わりがどこからなのか、データの一区切りがどうやって決まるのか、クロックと呼ばれるテンポを決めて判断します。  
クロックとは音楽で使うメトロノームみたいなものです。  
通信線に加えてクロック線を接続してクロックを同期させる方式を<b><u>同期式</u></b>、クロック線は用いずに予め機器同士でテンポを示し合わせておく方式を<b><u>非同期式</u></b>といいます。  
一般に、同期式の方が通信効率は高いです。

## 通信方式

電子工作においてよく使われる通信方式には以下の3種類があります。

* SPI通信
* I2CT通信
* UART通信  

詳細な説明は以下のサイトを読んでいただけるといいと思いますが、簡単な説明のみ記載します。

>参考サイト
>>* https://emb.macnica.co.jp/articles/8191/
>>* https://tonkun-tech.com/serial-uart-csi-i2c/

### SPI通信
SPI通信はデバイス間の通信を行うための通信規格で1つのマスターに対し、複数のスレーブを選択できます。  
この特性を実現するため、通信には以下の4本の線が必要とされます。

* <b>MOSI</b>(Master Out Slave In)……マスター→スレーブのデータ送信をします
* <b>MISO</b>(Master In Slave Out)……スレーブ→マスターのデータ送信をします
* <b>SCLK</b>(Serial Clock)……クロック線です
* <b>SS</b>(Slave Select)……複数のスレーブから任意のスレーブを区別します

SPIの配線は以下の画像のようになります。  
配線が多くなりますが、入出力にそれぞれ独立した線があり、同期式でもあるため、高速な通信が可能です。  
![SPI](https://www.analog.com/-/media/images/analog-dialogue/en/volume-52/number-3/articles/introduction-to-spi-interface/205973_fig_01.svg?la=en&imgver=3)

### I2C通信
I2CはSPIと異なり、データの入力も出力も1本の線で行います。  
そのため、データの通信速度はSPIに劣りますが、配線が少なくて済みます。

* <b>SDA</b>……データ通信用
* <b>SCL</b>……クロック用

  
![I2C](https://emb.macnica.co.jp/macnica_wp/wp-content/uploads/2019/10/d9ebfcc6af1db54f1fcec88bf22fc056.png)

I2Cは100kbps, 400kbpsの回線速度、<u>同じ基板内の近い機器同士</u>での通信を想定した通信方式であることには注意が必要です。  
また、I2Cは通信を行っていないデフォルト時は電圧がHighになっているので、抵抗を介してプルアップ(電圧をHighに安定させる)しておきます。

### UART通信
同期式通信であるSPIやI2Cに対して、UART通信はクロック線を必要としない<u>非同期式通信</u>です。  
通信には送信(Tx)と受信(Rx)でそれぞれ1本ずつ線を用います。  
![UART](https://emb.macnica.co.jp/macnica_wp/wp-content/uploads/2019/09/106e2d40d6f0e778a6f22cb54a731bc6.png)
通信を送信する端子を<b>Tx</b>(Transmitter)、受信する端子を<b>Rx</b>(Receiver)といい、Tx-Rxというように接続します。  
<b><u>SPIやI2Cのように同じ名前の端子同士を接続するわけではありません</u></b>。  
普段UARTに慣れておらずにI2Cのように基板設計をすると配線が面倒なことになってしまいます。

### 比較

最後に、各方式の通信の違いをざっくり表にしてみます。  
||通信速度|クロック|関係|
|----|----|----|----|
|SPI|~50Mbpk|同期式|1マスター⇔複数スレーブ|
|I2C|~1Mbps|同期式|複数マスター⇔複数スレーブ|
|UART|~500kbps|非同期式|1デバイス⇔1デバイス|

## 課題

```
1. コンピュータの信号入出力の多くはデジタル信号で行われる。デジタル信号がアナログ信号に比べ優れている点を考えましょう。
2. UART通信で取得したデータが文字化けを起こした時の原因を一つ考えましょう。
3. プルアップとプルダウンを行う必要性を調べて論じましょう。
```

## 参考

* https://www.kuwana-kagakugiken.jp/%E9%9B%91%E5%AD%A6%E8%AB%87%E8%A9%B1-%E9%9B%BB%E6%B0%97-%E3%83%A2%E3%83%BC%E3%82%BF%E3%83%BC%E3%81%AE%E3%81%AF%E3%81%AA%E3%81%97/%E7%AC%AC1%E7%AB%A0-%E9%9B%BB%E6%B1%A0%E3%81%AE%E3%81%AF%E3%81%AA%E3%81%97-1/1-7-%E9%9B%BB%E6%B5%81%E3%81%A8%E9%9B%BB%E5%9C%A7/
* https://www.youtube.com/watch?v=25kgoA2gpT0
* https://www.seikatsu110.jp/library/electrical/et_short_circuit/22553/
* https://tonkun-tech.com/serial-uart-csi-i2c/
* https://www.analog.com/jp/analog-dialogue/articles/introduction-to-spi-interface.html